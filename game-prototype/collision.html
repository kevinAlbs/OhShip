<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Game Prototype</title>
    <meta name="description" content="">
    <meta name="author" content="Kevin Albertson">

    <style type="text/css">
        #game {
            width: 800px;
            margin: 10px auto;
        }
    </style>

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body>
    <div id='game'></div>
    <label>Left Engine</label><input id="left_engine" type="range" min="-100" max="100" value="30"/><br/>
    <label>Right Engine</label><input id="right_engine" type="range" min="-100" max="100" value="-10"/>
    <script src="pixi.js"></script>
    <script>
        var stage = new PIXI.Container();
        var renderer = PIXI.autoDetectRenderer(800, 400);

        renderer.backgroundColor = 0x4b84f8;
 
        document.getElementById('game').appendChild(renderer.view);

        window.requestAnimationFrame(animate);

        var texture = PIXI.Texture.fromImage("ship.png");

        var shipShadow = new PIXI.Sprite(texture);
        shipShadow.tint = 0x00FF00;

        var left = 0, right = 0;

        var ship = new PIXI.Sprite(texture);
        ship.anchor.x = .5;
        ship.anchor.y = .5;
        ship.position.x = 100;
        ship.position.y = 150;
        

        // var shipMaskTexture = PIXI.Texture.fromImage('ship-mask.png');
        // var shipMask = new PIXI.Sprite(shipMaskTexture);
        
        var shipMask = new PIXI.Graphics();
        shipMask.beginFill(0x11F0F0);
        shipMask.drawRect(-50, -100, 100, 200);
        shipMask.endFill();


        shipShadow.anchor.x = .5;
        shipShadow.anchor.y = .5;
        shipShadow.position.x = 200;
        shipShadow.position.y = 152;


        
        stage.addChild(shipShadow);
        stage.addChild(ship);
        stage.addChild(shipMask);
        
        ship.mask = shipMask;

        function animate() {
            var leftInput = parseFloat(document.getElementById("left_engine").value);
            var rightInput = parseFloat(document.getElementById("right_engine").value);
            left = leftInput / 200;
            right = rightInput / 200;
            var forward = left + right;
            var angular = left - right;
            angular /= 100;
            
            shipMask.rotation = ship.rotation;
            shipMask.position.x = ship.position.x;
            shipMask.position.y = ship.position.y;


            ship.position.x += forward * Math.cos(ship.rotation - Math.PI / 2);
            ship.position.y += forward * Math.sin(ship.rotation - Math.PI / 2);
            ship.rotation += angular;

            // TODO: if bounding boxes of two ships are colliding, check colliding region
            // for overlapping pixels.
            // ship.alpha = .5;
            // shipShadow.alpha = .5;
            // canvasRenderer.context.clearRect(0,0,800,600);
            // canvasRenderer.render(ship);
            // canvasRenderer.render(shipShadow);
            // var imgData = canvasRenderer.context.getImageData(0,0,800,600);
            // for (var i = 0; i < imgData.data; i += 4) {
            //     var r = imgData[i],
            //         g = imgData[i+1],
            //         b = imgData[i+2],
            //         a = imgData[i+3];
            //     if (a > 1) {
            //         console.log("collision");
            //     }
            // }
            // ship.alpha = 1;
            // shipShadow.alpha = 1;
            



            // render the stage   
            renderer.render(stage);
            window.requestAnimationFrame(animate);
        }
    </script>
</body>
</html>