<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Ships</title>
    <meta name="description" content="">
    <meta name="author" content="Kevin Albertson">

    <style type="text/css">

        #container {
            width: 1000px;
            margin: 0px auto;
        }
    </style>

    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

<body>
    <div id="container">
        <div id='game'></div>
        <div id='debug-controls'></div>
    </div>

    <script src="/client_message.js"></script>
    <script src="/server_response.js"></script>
    <script src='/js/vendor/underscore.js'></script>
    <script src='/js/vendor/pixi.js'></script>
    <script src='/js/client_ship.js'></script>
    <script src='/js/client_cannonball.js'></script>

    <script>
        // Constants.
        var kFixedDelta = 60
            kMaxDelta = 500
            ;

        var playerMap = new Map()
            , playerId = null
            , cannonballs = []
            , ws = new WebSocket('ws://localhost:4080')
            , stage = new PIXI.Container()
            , renderer = PIXI.autoDetectRenderer(1000, 600)
            , serverResponseBuffer = []
            , prevTime = 0
            ;

        ws.addEventListener('message', onServerResponse);

        function tick() {
            var currentTime = Date.now();
            var delta = currentTime - prevTime;
            prevTime = currentTime;
            if (delta > kMaxDelta) {
                window.requestAnimationFrame(tick);
                return;
            }

            // Apply pending updates from server.
            while(serverResponseBuffer.length > 0) {
                applyServerResponse(serverResponseBuffer.shift());
            }

            // Interpolate.
            playerMap.forEach(function(player) {
                var ship = player.ship;
                if (ship) {
                    ship.tick(delta);
                    if (ship.isFinishedSinking()) {
                        player.ship = null;
                    }
                }
            });

            cannonballs.filter(function(cannonball) {
                cannonball.tick(delta);
                return !cannonball.isSunk();
            });

            renderer.render(stage);
            window.requestAnimationFrame(tick);
        }
        
        function onServerResponse(raw) {
            let json = ServerResponse.decode(raw.data);
            console.log('Recieved from server', json);
            serverResponseBuffer.push(json);
        }

        // Called at the beginning of the frame.
        function applyServerResponse(json) {
            console.log('Applying', json);
            let id = json.id;
            let player = playerMap.has(id) ? playerMap.get(id) : null;
            let ship = player ? player.ship : null;
            switch (json.type) {
                case ServerResponse.type.kWelcome:
                    play(id);
                    break;
                case ServerResponse.type.kSpawn:
                    if (!player) return;
                    player.ship = new ClientShip(json.data);
                    break;
                case ServerResponse.type.kJoin:
                    if (player) return;
                    playerMap.set(id, json);
                    break;
                case ServerResponse.type.kRefresh:
                    // TODO: clear all ships first?
                    json.data.forEach(function(playerData) {
                        if (playerMap.has(playerData.id)) return;
                        let player = {
                            id: playerData.id
                        };
                        if (playerData.hasOwnProperty('ship')) {
                            player.ship = new ClientShip(playerData.ship);
                        }
                        playerMap.set(playerData.id, player);
                    });
                    break;
                case ServerResponse.type.kShipUpdate:
                    if (!player || !ship) return;
                    ship.applyServerUpdate(json);
                    break;
                case ServerResponse.type.kCannonFire:
                    if (!player || !ship) return;
                    var cannonball = ship.attemptCannonFire();
                    if (cannonball) cannonballs.push(cannonball);
                    break;
            }
        }

        function sendJson(json) {
            ws.send(ClientMessage.encode(json));
        }
        
        function play(id) {
            playerId = id;
            sendJson({
                type: ClientMessage.type.kJoin,
                nickname: "kevin" + playerId
            });
        }

        renderer.backgroundColor = 0x4b84f8;
        document.getElementById('game').appendChild(renderer.view);
        tick();


    </script>

    <script src='/js/debug_controls.js'></script>
</body>
</html>